{#
    invoice_template.html.twig

    Ce template génère une facture ou un devis basé sur les entités Document, DocumentLine, et DocumentLineTotals.
    Il utilise une mise en page basée sur les tableaux pour une meilleure compatibilité Dompdf.

    Variables attendues :
    - document: L'objet App\Entity\Document à afficher.
    - legales: L'objet App\Entity\LegalInformation contenant les détails de la société.
    - logo_path: (string, optionnel) Chemin vers l'image du logo de votre entreprise.
#}

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        {% if document.billNumber %}
            Facture n°{{ document.billNumber }}
        {% else %}
            Devis n°{{ document.quoteNumber }}
        {% endif %}
    </title>
    <style>
        /* Pour supprimer les marges par défaut de la page PDF */
        @page {
            margin: 0;
        }

        * {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        body {
            margin: 0.8cm 0cm 0cm 0cm; /* Ex: 0.8cm en haut, 0cm partout ailleurs */
            padding: 0cm;
            color: #333;
            line-height: 1.4;
            font-size: 0.32cm; /* Converti de 12px */
        }

        .invoice-container {
            width: 19cm; /* Largeur du contenu (19cm) + 2*0.5cm (padding horizontal) = 20cm de largeur totale pour le container */
            padding: 0.3cm 0.5cm; /* 0.3cm haut/bas, 0.5cm gauche/droite */
            margin: 0cm auto; /* Centre le container horizontalement. La marge top de 0cm ici est relative au body qui a déjà sa propre marge. */
            border: 0.026cm solid #eee;
            box-shadow: 0cm 0cm 0.26cm rgba(0, 0, 0, 0.05);
            background: #fff;
            border-radius: 0.21cm;
            overflow: hidden;
            position: relative;
            z-index: 1;
        }

        /* Styles généraux pour tous les tableaux de mise en page */
        .layout-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0.53cm; /* Espacement entre les sections */
        }
        .layout-table td {
            vertical-align: top;
            padding: 0cm; /* Réinitialiser le padding par défaut des cellules */
        }

        /* En-tête de la facture */
        .invoice-header {
            /* La marge est maintenant sur le body, pas sur cet élément directement */
        }
        .invoice-header .header-left-cell {
            width: 55%;
            padding-right: 0.4cm;
            padding-left: 0.26cm; /* Pour aligner avec les adresses */
        }
        .invoice-header .header-right-cell {
            width: 42%;
            text-align: right;
        }
        .invoice-header .logo {
            max-width: 3.44cm;
            height: auto;
            margin-right: 0.26cm;
            margin-bottom: 0cm;
        }
        .company-details-logo-section p {
            margin: 0cm;
            line-height: 1.3;
            font-size: 0.29cm;
        }
        .header-right-cell h1 {
            font-size: 0.74cm;
            color: #0056b3;
            margin-top: 0cm;
            margin-bottom: 0.13cm;
        }
        .document-meta-info p {
            margin: 0cm;
            line-height: 1.3;
            font-size: 0.29cm;
        }

        /* Section des adresses */
        .address-section .address-cell {
            width: 49%;
            border: 0.026cm solid #eee;
            padding: 0.26cm; /* Garde le padding interne pour la boîte d'adresse */
            border-radius: 0.13cm;
            background-color: #f9f9f9;
        }
        .address-section h3 {
            font-size: 0.37cm;
            color: #555;
            margin-top: 0cm;
            margin-bottom: 0.13cm;
            border-bottom: 0.026cm solid #ddd;
            padding-bottom: 0.08cm;
        }
        .address-section p {
            margin: 0cm;
            line-height: 1.3;
        }

        /* Tableau des articles */
        .invoice-items {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0cm;
        }
        .invoice-items th,
        .invoice-items td {
            border: 0.026cm solid #eee;
            padding: 0.21cm;
            text-align: left;
        }
        .invoice-items th:last-child,
        .invoice-items td:last-child {
            text-align: right;
        }
        .invoice-items th {
            background-color: #0056b3;
            color: #fff;
            font-weight: bold;
        }
        .invoice-items tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        /* Conteneur pour les totaux */
        .totals-section {
            margin-top: 0.8cm;
        }
        .totals-section .layout-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0.53cm;
        }
        .totals-section .totals-spacer-cell {
            width: 65%;
        }
        .totals-section .invoice-totals-cell {
            width: 35%;
            padding-top: 0.4cm;
            /* *** MODIFIÉ: Ajout de text-align: right; pour positionner l'inline-block enfant *** */
            text-align: right;
        }
        .invoice-totals {
            width: 6.5cm;
            border: 0.026cm solid #eee;
            padding: 0.26cm;
            border-radius: 0.13cm;
            background-color: #f9f9f9;
            margin-top: 0cm;
            margin-bottom: 0cm;
            /* *** MODIFIÉ: Passage en inline-block pour que text-align: right sur le parent fonctionne *** */
            display: inline-block;
            /* margin-left: auto; et margin-right: 0cm; ne sont plus nécessaires avec cette combinaison */
        }
        /* Technique d'alignement pour le contenu interne des totaux (remplace display: flex) */
        .invoice-totals p {
            margin: 0cm 0cm 0.13cm 0cm;
            font-size: 0.32cm;
            line-height: 1.3; /* Assure une bonne hauteur de ligne pour les flottants */
        }
        .invoice-totals p span:first-child {
            float: left;
        }
        .invoice-totals p span:last-child {
            float: right;
        }
        .invoice-totals p::after { /* Clearfix pour contenir les floats dans chaque paragraphe */
            content: '';
            display: block;
            clear: both;
        }
        .invoice-totals .total-amount {
            font-size: 0.42cm;
            font-weight: bold;
            color: #0056b3;
            border-top: 0.026cm solid #ddd;
            padding-top: 0.16cm;
            margin-top: 0.16cm;
        }

        /* Pied de page */
        .invoice-footer-table {
            margin-top: 0.53cm;
            width: 100%;
            border-collapse: collapse;
            border-top: 0.026cm solid #eee;
            padding-top: 0.16cm;
        }
        .invoice-footer-table td {
            vertical-align: top;
            padding: 0.16cm 0.08cm;
        }
        .invoice-footer-table .footer-left-cell {
            width: 57%;
            text-align: left;
        }
        .invoice-footer-table .footer-right-cell {
            width: 41%;
            text-align: right;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: clip;
        }
        .invoice-footer p {
            margin: 0;
            line-height: 1.05;
            font-size: 0.22cm;
            color: #777;
        }

        /* Styles spécifiques à l'impression */
        @media print {
            body {
                margin: 0cm;
                padding: 0cm;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
                print-color-adjust: exact;
            }
            .invoice-container {
                box-shadow: none;
                border: none;
            }
            .invoice-items thead {
                display: table-header-group;
            }
            .invoice-items tr {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>

    <div class="invoice-container">

        <div class="invoice-header">
            <table class="layout-table">
                <tr>
                    <td class="header-left-cell">
                        <img src="{{ absolute_url( asset('assets/logoSite.png') ) }}" alt="Logo de l'entreprise" class="logo">
                        <div class="company-details-logo-section">
                            {% if legales is defined and legales is not null %}
                                <p>{{ legales.streetCompany }}</p>
                                <p>{{ legales.postalCodeCompany }} {{ legales.cityCompany }}</p>
                                <p>SIRET: {{ legales.siretCompany }}</p>
                            {% else %}
                                <p>[Adresse de l'entreprise]</p>
                                <p>[Code postal Ville]</p>
                                <p>SIRET: [SIRET]</p>
                            {% endif %}
                        </div>
                    </td>
                    <td class="header-right-cell">
                        <h1>
                            {% if document.billNumber %}
                                FACTURE
                            {% else %}
                                DEVIS
                            {% endif %}
                        </h1>
                        <div class="document-meta-info">
                            <p>
                                {% if document.billNumber %}
                                    Facture n°: <strong>{{ document.billNumber }}</strong>
                                {% else %}
                                    Devis n°: <strong>{{ document.quoteNumber }}</strong>
                                {% endif %}
                            </p>
                            <p>Date de création: {{ document.createdAt|date('d/m/Y') }}</p>
                            {% if document.sendingNumber %}
                                <p>Numéro d'envoi: {{ document.sendingNumber }}</p>
                            {% endif %}
                            {% if document.sendingAt %}
                                <p>Envoyé le: {{ document.sendingAt|date('d/m/Y H:i') }}</p>
                            {% endif %}
                            {% if document.endOfQuoteValidation and not document.billNumber %}
                                <p>Date de fin de validité: {{ document.endOfQuoteValidation|date('d/m/Y') }}</p>
                            {% endif %}
                        </div>
                    </td>
                </tr>
            </table>
        </div>

        <div class="address-section">
            <table class="layout-table">
                <tr>
                    <td class="address-cell">
                        <h3>Adresse de Facturation</h3>
                        {% set billings = document.billingAddress|split('<br/>') %}
                        {% for line in billings %}
                            {% set trimmed_line = line|trim %}
                            {% if trimmed_line|length > 0 %}
                                {{ trimmed_line }}<br/>
                            {% endif %}
                        {% endfor %}
                    </td>
                    <td style="width: 2%;"></td>
                    <td class="address-cell">
                        <h3>Adresse de Livraison</h3>
                        {% set deliveries = document.deliveryAddress|split('<br/>') %}
                        {% for line in deliveries %}
                            {% set trimmed_line = line|trim %}
                            {% if trimmed_line|length > 0 %}
                                {{ trimmed_line }}<br/>
                            {% endif %}
                        {% endfor %}
                    </td>
                </tr>
            </table>
        </div>

        <table class="invoice-items layout-table">
            <thead>
                <tr>
                    <th>Description</th>
                    <th>Total HT</th>
                </tr>
            </thead>
            <tbody>
                {% for line in document.documentLines %}
                    {% if line.priceExcludingTax != 0 %}
                        <tr>
                            <td>
                                {% if line.boite %}
                                    {{ line.boite.name|default('Boîte') }}
                                {% elseif line.occasion %}
                                    {{ line.occasion.name|default('Occasion') }}
                                {% elseif line.item %}
                                    {{ line.item.name|default('Article') }}
                                {% else %}
                                    Produit/Service
                                {% endif %}
                                {% if line.question and line.answer %}
                                    <br><small>Question: {{ line.question }}</small>
                                    <br><small>Réponse: {{ line.answer }}</small>
                                {% endif %}
                            </td>
                            <td>{{ ((line.quantity * line.priceExcludingTax) / 100)|number_format(2, ',', ' ') }} &euro;</td>
                        </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>

        <div class="totals-section">
            <table class="layout-table">
                <tr>
                    <td class="totals-spacer-cell"></td>
                    <td class="invoice-totals-cell">
                        <div class="invoice-totals">
                            {% if document.documentLineTotals %}
                                {% if document.documentLineTotals.itemsPriceWithoutTax > 0 %}
                                    <p>
                                        <span>Total Articles (HT):</span>
                                        <span>{{ (document.documentLineTotals.itemsPriceWithoutTax / 100)|number_format(2, ',', ' ') }} &euro;</span>
                                    </p>
                                {% endif %}
                                {% if document.documentLineTotals.occasionsPriceWithoutTax > 0 %}
                                    <p>
                                        <span>Total Occasions (HT):</span>
                                        <span>{{ (document.documentLineTotals.occasionsPriceWithoutTax / 100)|number_format(2, ',', ' ') }} &euro;</span>
                                    </p>
                                {% endif %}
                                {% if document.documentLineTotals.boitesPriceWithoutTax > 0 %}
                                    <p>
                                        <span>Sous-total (HT):</span>
                                        <span>{{ (document.documentLineTotals.boitesPriceWithoutTax / 100)|number_format(2, ',', ' ') }} &euro;</span>
                                    </p>
                                {% endif %}
                                {% if document.cost > 0 %}
                                    <p>
                                        <span>Frais de préparation (HT):</span>
                                        <span>{{ (document.cost / 100)|number_format(2, ',', ' ') }} &euro;</span>
                                    </p>
                                {% endif %}

                                {% if document.documentLineTotals.discountonpurchase > 0 %}
                                    <p>
                                        <span>Remise:</span>
                                        <span>- {{ (document.documentLineTotals.discountonpurchase / 100)|number_format(2, ',', ' ') }} &euro;</span>
                                    </p>
                                {% endif %}
                                {% if document.documentLineTotals.discountonpurchaseinpurcentage is not null %}
                                    <p>
                                        <span>Remise (%):</span>
                                        <span>{{ document.documentLineTotals.discountonpurchaseinpurcentage }} %</span>
                                    </p>
                                {% endif %}
                                {% if document.documentLineTotals.voucherDiscountValueUsed > 0 %}
                                    <p>
                                        <span>Réduction Bon:</span>
                                        <span>- {{ (document.documentLineTotals.voucherDiscountValueUsed / 100)|number_format(2, ',', ' ') }} &euro;</span>
                                    </p>
                                {% endif %}
                            {% endif %}

                            <p>
                                <span>Frais de livraison (HT):</span>
                                <span>{{ (document.deliveryPriceExcludingTax / 100)|number_format(2, ',', ' ') }} &euro;</span>
                            </p>
                            <p>
                                <span>Total HT:</span>
                                <span>{{ (document.totalExcludingTax / 100)|number_format(2, ',', ' ') }} &euro;</span>
                            </p>
                            <p class="total-amount">
                                <span>Total TTC:</span>
                                <span>{{ (document.totalWithTax / 100)|number_format(2, ',', ' ') }} &euro;</span>
                            </p>
                        </div>
                    </td>
                </tr>
            </table>
        </div>

        <div class="invoice-footer">
            <table class="invoice-footer-table">
                <tr>
                    <td class="footer-left-cell">
                        {% if legales is defined and legales is not null %}
                            <p>Retrouvez-nous sur notre site web: <a href="{% if legales.fullUrlCompany %}{{ legales.fullUrlCompany }}{% else %}#{% endif %}" style="color: #777; text-decoration: none;">{{ legales.fullUrlCompany|replace({'http://': '', 'https://': ''}) }}</a></p>
                            <p>&copy; {{ "now"|date("Y") }} {{ legales.companyName }}.</p>
                        {% else %}
                            <p>Retrouvez-nous sur notre site web: [Votre Site Web]</p>
                            <p>&copy; {{ "now"|date("Y") }} [Votre Entreprise].</p>
                        {% endif %}
                    </td>
                    <td class="footer-right-cell">
                        <p>Tva non applicable, article 293B du code général des impôts</p>
                    </td>
                </tr>
            </table>
        </div>

    </div>

</body>
</html>